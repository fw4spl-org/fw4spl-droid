
<plugin id="DroidTracking" version="0.1" >

    <xi:include href="configurations/deviceParameters.xml" xmlns:xi="http://www.w3.org/2003/XInclude" />

    <extension implements="::fwServices::registry::AppConfig">
        <id>DroidTrackingConfig</id>
        <type>parameters</type>
        <config>
            <object type="::fwData::Composite">
                <service uid="scene" impl="::fwRenderVTK::VtkRenderService" type="::fwRender::IRender" autoConnect="yes">
                    <scene autoRender="true">
                       <renderer id="background" layer="0" background="#000000"/>
                        <renderer id="default" layer="1" background="#000000" />

                        <adaptor id="transformAdaptor" class="::visuVTKDroidAdaptor::STransform" objectId="transform">
                            <config renderer="default" transform="transformMesh"/>
                        </adaptor>

                        <adaptor id="meshAdaptor" class="::visuVTKDroidAdaptor::SMesh" objectId="mesh">
                            <config renderer="default" transform="transformMesh" autoresetcamera="no" />
                        </adaptor>

                        <adaptor id="cameraAdaptor" class="::visuVTKARAdaptor::SCamera" objectId="cameraTransform">
                            <config renderer="default" cameraUID="camera" imageUID="image" />
                        </adaptor>

                        <adaptor id="videoAdapter" class="::visuVTKARAdaptor::SVideoAdapter" objectId="image">
                            <config renderer="background" cameraUID="camera"/>
                        </adaptor>

                         <adaptor id="interactorStyle" class="::visuVTKDroidAdaptor::InteractorStyle" objectId="self">
                            <config renderer="default" style="FixedInteractorStyle" />
                        </adaptor>
                    </scene>
                </service>
                
                <service uid="tracker" impl="::trackerAruco::SArucoTracker" autoConnect="no" worker="tracking">
                    <config>
                        <timelineVideo>frameTL</timelineVideo>
                        <camera>camera</camera>
                        <track>
                            <marker id="101" timeline="markerTL" />
                        </track>
                        <threshold>
                            <method>ADPT_THRES</method>
                            <blockSize>7</blockSize>
                            <constant>7</constant>
                        </threshold>
                        <patternWidth>60</patternWidth>
                        <debugMarkers>yes</debugMarkers>
                    </config>
                </service>
                
                <service uid="markerRegistration" impl="::tracker::SHomography" autoConnect="no" worker="registration">
                    <config>
                        <markerTL>
                            <key>markerTL</key>
                        </markerTL>
                        <camera>
                            <key>camera</key>
                        </camera>
                        <matrixTL>markerMatrixTL</matrixTL>
                        <patternWidth>60</patternWidth>
                    </config>
                </service>
                
                <service uid="synchronizer" impl="::videoTools::SFrameMatrixSynchronizer" autoConnect="no" worker="videoWorker">
                    <frames>
                        <frame from="frameTL" to="image" />
                    </frames>
                    <matrices>
                        <timeline from="markerMatrixTL">
                            <matrix index="0" to="transform" />
                        </timeline>
                    </matrices>
                    <framerate>60</framerate>
                </service>
                
                <item key="markerTL">
                    <object uid="markerTLUid" type="::arData::MarkerTL" />
                </item>
                
                <item key="markerMatrixTL">
                    <object uid="markerMatrixTLUid" type="::extData::MatrixTL" />
                </item>
                
                <item key="transform">
                    <object uid="transform" type="::fwData::TransformationMatrix3D">
                    </object>
                </item>

                <item key="camera">
                    <object uid="camera" type="::arData::Camera">
                        <service uid="extractDeviceInfo" impl="::ctrlCamera::SExtractDeviceInfo" type="::fwServices::IController" autoConnect="no">
                            <cameraUid>camera</cameraUid>
                            <configId>DeviceSelectorServiceConfig</configId>
                        </service>
                    </object>
                </item>
                
               <item key="mesh">
                    <object uid="mesh" type="::fwData::Mesh">
                        <service uid="meshReader" impl="::ioVTK::MeshReaderService" type="::io::IReader" autoConnect="yes">
                             <file>/data/data/com.fw4spl.DroidTracking/Bundles/DroidTracking_0-1/cube.vtk</file>
                        </service>
                    </object>
                </item>
                
                <item key="frameTL">
                    <object uid="frameTLUid" type="::extData::FrameTL">
                        <service uid="androidCamera" impl="::visuVideoAndroid::camera::SAndroidCamera" type="::fwServices::IService" autoConnect="no">
                            <cameraId>0</cameraId>
                            <autoFocus>true</autoFocus>
                            <width>640</width>
                            <height>480</height>
                            <fps>60</fps>
                        </service>
                        <value>50</value>
                    </object>
                </item>

                <item key="cameraTransform">
                    <object uid="cameraTransform" type="::fwData::TransformationMatrix3D">
                    </object>
                </item>
                
                <item key="image">
                    <object uid="image" type="::fwData::Image">
                    </object>
                </item>

                <start uid="extractDeviceInfo" />
                <start uid="meshReader" />
                <start uid="scene" />
                <start uid="androidCamera" />
    
                <start uid="synchronizer" />
                <start uid="tracker" />
                <start uid="markerRegistration" />
                
                <update uid="extractDeviceInfo" />
                <update uid="meshReader" />
                <update uid="androidCamera" />

            </object>
        </config>
    </extension> 
</plugin>
